@using Microsoft.AspNetCore.Components.Authorization
@using UI.Models
@using UI.Services
@inject IErrorHandler ErrorHandler
@inject IThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudThemeProvider @bind-IsDarkMode="@ThemeService.IsDarkMode"
				  Theme="@ThemeService.Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
	<MudAppBar Elevation="1">
		<MudIconButton Icon="@Icons.Material.Filled.Menu"
					   Color="Color.Inherit"
					   Edge="Edge.Start"
					   OnClick="@((e) => DrawerToggle())" />
		<MudText Typo="Typo.h5"
				 Class="ml-3">
			Расписание выездов
		</MudText>
		<MudSpacer />
		<MudToggleIconButton Toggled="@ThemeService.IsDarkMode"
							 ToggledChanged="OnThemeChanged"
							 Icon="@Icons.Material.Filled.DarkMode"
							 ToggledIcon="@Icons.Material.Filled.LightMode"
							 title="@(ThemeService.IsDarkMode ? "Светлая тема" : "Темная тема")" />

		@if (_user != null)
		{
			<MudMenu>
				<ActivatorContent>
					<MudButton EndIcon="@Icons.Material.Filled.ArrowDropDown"
							   Color="Color.Inherit"
							   Style="text-transform: none;"
							   Variant="Variant.Text">
						<MudIcon Icon="@Icons.Material.Filled.AccountCircle"
								 Class="mr-2"
								 Size="Size.Medium" />
						@_user.Name @_user.LastName
					</MudButton>
				</ActivatorContent>
				<ChildContent>
					<MudMenuItem Icon="@Icons.Material.Filled.Logout"
								 OnClick="Logout">
						Выйти
					</MudMenuItem>
				</ChildContent>
			</MudMenu>
		}
		else
		{
			<MudButton Color="Color.Inherit" Href="/login" Variant="Variant.Text">
				<MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-2" />
				Войти
			</MudButton>
		}
	</MudAppBar>
	@if (_user != null)
	{
		<MudDrawer @bind-Open="@_drawerOpen"
				   ClipMode="DrawerClipMode.Always"
				   Elevation="4">
			<NavMenu />
		</MudDrawer>
	}
	<MudMainContent>
		@Body
	</MudMainContent>
</MudLayout>

@code {
	private bool _drawerOpen = true;
	private EmployeeMinimal? _user;
	private bool _welcomeShown = false;

	[CascadingParameter]
	private Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

	protected override async Task OnInitializedAsync()
	{
		AuthenticationStateTask = AuthenticationStateProvider.GetAuthenticationStateAsync();
		var authState = await AuthenticationStateTask;

		await LoadUserData();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			try
			{
				await ThemeService.InitializeAsync();
				await ErrorHandler.InitializeAsync();

				await CheckAndShowWelcome();

				StateHasChanged();
			}
			catch (Exception ex)
			{
				NotificationService.ShowError($"Ошибка инициализации: {ex.Message}");
			}
		}
	}

	private async Task LoadUserData()
	{
		_user = await AuthService.GetCurrentEmployeeAsync();
	}

	private async Task CheckAndShowWelcome()
	{
		if (_welcomeShown || _user == null) return;

		var showWelcome = await AuthService.IsWelcomeFlagSet();
		if (showWelcome)
		{
			NotificationService.ShowSuccess($"Добро пожаловать, {_user.Name}");
			await AuthService.ClearWelcomeFlag();
			_welcomeShown = true;
		}
	}

	private async Task OnThemeChanged(bool newValue)
	{
		await ThemeService.ToggleThemeAsync(newValue);
	}

	void DrawerToggle()
	{
		_drawerOpen = !_drawerOpen;
	}

	private async Task Logout()
	{
		await AuthService.LogoutAsync();
		NavigationManager.NavigateTo("/login", forceLoad: true);
	}
}