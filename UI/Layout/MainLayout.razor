@using Microsoft.AspNetCore.Components.Authorization
@using UI.Services
@inject IErrorHandler ErrorHandler
@inject IThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudThemeProvider @bind-IsDarkMode="@ThemeService.IsDarkMode"
				  Theme="@ThemeService.Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
	<MudAppBar Elevation="1">
		<MudIconButton Icon="@Icons.Material.Filled.Menu"
					   Color="Color.Inherit"
					   Edge="Edge.Start"
					   OnClick="@((e) => DrawerToggle())" />
		<MudText Typo="Typo.h5"
				 Class="ml-3">
			Расписание выездов
		</MudText>
		<MudSpacer />
		<MudToggleIconButton Toggled="@ThemeService.IsDarkMode"
							 ToggledChanged="OnThemeChanged"
							 Icon="@Icons.Material.Filled.DarkMode"
							 ToggledIcon="@Icons.Material.Filled.LightMode"
							 title="@(ThemeService.IsDarkMode ? "Светлая тема" : "Темная тема")" />
		<MudTooltip Text="Открыть меню пользователя" Delay="800">
			<MudMenu Icon="@Icons.Material.Filled.AccountCircle"
					 Color="Color.Inherit"
					 AriaLabel="Открыть меню пользователя">
				<MudMenuItem Label="Выйти" OnClick="() => {AuthService.LogoutAsync();}" />
			</MudMenu>
		</MudTooltip>
	</MudAppBar>
	<MudDrawer @bind-Open="@_drawerOpen"
			   ClipMode="DrawerClipMode.Always"
			   Elevation="4">
		<NavMenu />
	</MudDrawer>
	<MudMainContent>
		@Body
	</MudMainContent>
</MudLayout>

@code {
	private bool _drawerOpen = true;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			try
			{
				await ThemeService.InitializeAsync();
				await ErrorHandler.InitializeAsync();
				StateHasChanged();
			}
			catch (Exception ex)
			{
				NotificationService.ShowError($"Ошибка инициализации: {ex.Message}");
			}
		}
	}

	private async Task OnThemeChanged(bool newValue)
	{
		await ThemeService.ToggleThemeAsync(newValue);
	}

	void DrawerToggle()
	{
		_drawerOpen = !_drawerOpen;
	}
}