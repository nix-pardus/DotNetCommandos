@page "/clients"
@using Microsoft.AspNetCore.Authorization
@using UI.Models
@using UI.Models.Clients
@using UI.Services
@using UI.Components
@inject IClientService ClientService
@inject INotificationService NotificationService
@inject IDialogService DialogService

@attribute [Authorize]

<MudDataGrid @ref="dataGrid"
			 T="Client"
			 ServerData="@ServerReload"
			 Filterable="true"
			 FilterMode="DataGridFilterMode.ColumnFilterMenu"
			 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
			 SortMode="SortMode.Multiple"
			 Hideable="true"
			 DragDropColumnReordering="true"
			 RowsPerPage="10"
			 FixedHeader="true"
			 Hover="true"
			 Loading="@loading">

	<ToolBarContent>
		<MudText Typo="Typo.h6">Клиенты</MudText>
		<MudSpacer />

		<MudButton OnClick="CreateClient" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">
			Создать клиента
		</MudButton>

		@* Selector видимости колонок *@
		<MudTooltip Text="Видимость колонок">
			<ColumnVisibilitySelector Columns="columns" VisibleColumnsChanged="StateHasChanged"/>
		</MudTooltip>

		<MudTooltip Text="Показать/скрыть удаленных клиентов">
			<MudSwitch @bind-Value="showDeleted" @bind-Value:after="OnShowDeletedChanged" Color="Color.Primary" Label="Показать удаленных" />
		</MudTooltip>
		<MudSpacer />

		<MudTextField T="string"
					  Value="@searchString"
					  ValueChanged="@OnSearch"
					  Placeholder="Быстрый поиск..."
					  Adornment="Adornment.Start"
					  AdornmentIcon="@Icons.Material.Filled.Search"
					  IconSize="Size.Medium"
					  Immediate="true"
					  Class="mt-0" />
	</ToolBarContent>

	<Columns>
		<PropertyColumn T="Client" TProperty="string" Property="x => x.LastName"
						Title="Фамилия" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.LastName))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.Name"
						Title="Имя" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.Name))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.Patronymic"
						Title="Отчество" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.Patronymic))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.Address"
						Title="Адрес" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.Address))!.Visible)">
			<CellTemplate>
				<MudTooltip Text="@context.Item.Address" Delay="500">
					<MudText Style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
						@context.Item.Address
					</MudText>
				</MudTooltip>
			</CellTemplate>
		</PropertyColumn>

		<PropertyColumn T="Client" TProperty="string" Property="x => x.City"
						Title="Город" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.City))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.Region"
						Title="Район" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.Region))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.CompanyName"
						Title="Компания" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.CompanyName))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.Email"
						Title="Email" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.Email))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="x => x.PhoneNumber"
						Title="Телефон" Sortable="false" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.PhoneNumber))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string" Property="@(x => x.CreatedDate.ToLocalTime().ToString(" dd.MM.yyyy HH:mm"))"
						Title="Дата создания" Sortable="true" Filterable="false"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.CreatedDate))!.Visible)" />

		<PropertyColumn T="Client" TProperty="string"
						Property="@(x => x.ModifiedDate.HasValue ? x.ModifiedDate!.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm") : "-")"
						Title="Дата изменения" Sortable="true" Filterable="false"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.ModifiedDate))!.Visible)" />

		<PropertyColumn T="Client" TProperty="bool" Property="x => x.IsDeleted"
						Title="Статус" Sortable="true" Filterable="true"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == nameof(Client.IsDeleted))!.Visible)">
			<CellTemplate>
				@if (context.Item.IsDeleted)
				{
					<MudChip Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Удален</MudChip>
				}
				else
				{
					<MudChip Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Активен</MudChip>
				}
			</CellTemplate>
		</PropertyColumn>

		<PropertyColumn T="Client" TProperty="bool" Property="x => false"
						Title="Действия" Filterable="false" Sortable="false"
						Hidden="@(!columns.FirstOrDefault(x => x.Key == "Actions")!.Visible)">
			<CellTemplate>
				@{
					async Task Edit() => await EditClient(context.Item);
					async Task Delete() => await DeleteClient(context.Item);
				}

				<MudIconButton Icon="@Icons.Material.Filled.Edit"
							   Size="Size.Small"
							   Color="Color.Primary"
							   OnClick="Edit" />

				<MudIconButton Icon="@Icons.Material.Filled.Delete"
							   Size="Size.Small"
							   Color="Color.Error"
							   OnClick="Delete" />
			</CellTemplate>
		</PropertyColumn>
	</Columns>

	<PagerContent>
		<MudDataGridPager T="Client" />
	</PagerContent>

	<LoadingContent>
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" />
	</LoadingContent>

	<NoRecordsContent>
		<MudText Typo="Typo.body1" Class="pa-4">Нет клиентов для отображения</MudText>
	</NoRecordsContent>

</MudDataGrid>

@code {
	private MudDataGrid<Client> dataGrid;
	private bool loading = false;
	private bool showDeleted = false;
	private string searchString = string.Empty;
	private Timer? searchDebounceTimer;
	private const int SEARCH_DEBOUNCE_MS = 500;

	private List<ColumnVisibilityItem> columns = new()
	{
		new ColumnVisibilityItem { Key = nameof(Client.LastName), Label = "Фамилия" },
		new ColumnVisibilityItem { Key = nameof(Client.Name), Label = "Имя" },
		new ColumnVisibilityItem { Key = nameof(Client.Patronymic), Label = "Отчество" },
		new ColumnVisibilityItem { Key = nameof(Client.City), Label = "Город" },
		new ColumnVisibilityItem { Key = nameof(Client.Address), Label = "Адрес" },
		new ColumnVisibilityItem { Key = nameof(Client.Region), Label = "Район" },
		new ColumnVisibilityItem { Key = nameof(Client.PhoneNumber), Label = "Телефон" },
		new ColumnVisibilityItem { Key = nameof(Client.Email), Label = "Email" },
		new ColumnVisibilityItem { Key = nameof(Client.CompanyName), Label = "Компания" },
		new ColumnVisibilityItem { Key = nameof(Client.CreatedDate), Label = "Дата создания" },
		new ColumnVisibilityItem { Key = nameof(Client.ModifiedDate), Label = "Дата изменения" },
		new ColumnVisibilityItem { Key = nameof(Client.IsDeleted), Label = "Статус" },
		new ColumnVisibilityItem { Key = "Actions", Label = "Действия" }
	};


	private async Task<GridData<Client>> ServerReload(GridState<Client> state)
	{
		loading = true;

		try
		{
			var sortBy = state.SortDefinitions.Select(sort => new GetByFiltersRequest.Sorting
			{
				Field = MapPropertyToField(sort.SortBy),
				Direction = sort.Descending
			}).ToList();

			var filters = new List<GetByFiltersRequest.FilterCondition>();

			if (!showDeleted)
			{
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "IsDeleted",
					Operator = GetByFiltersRequest.FilterOperator.Equals,
					Value = "false",
					ValueType = "string"
				});
			}

			if (!string.IsNullOrWhiteSpace(searchString))
			{
				// один фильтр: Name||LastName -> сервер распарсит и сделает OR между полями
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "Name||LastName||Address||City||Region||CompanyName||Email||PhoneNumber",
					Operator = GetByFiltersRequest.FilterOperator.Contains,
					Value = searchString,
					ValueType = "string"
				});
			}

			foreach (var filter in state.FilterDefinitions)
			{
				if (filter is IFilterDefinition<Client> columnFilter)
				{
					string operatorString = !string.IsNullOrEmpty(columnFilter.Operator)
						? columnFilter.Operator
						: "contains";

					var filterCondition = new GetByFiltersRequest.FilterCondition
					{
						Field = MapPropertyToField(columnFilter.Column.PropertyName),
						Operator = MapFilterOperator(operatorString),
						Value = columnFilter.Value?.ToString() ?? "",
						ValueType = GetValueType(columnFilter.Value)
					};
					filters.Add(filterCondition);
				}
			}

			var request = new GetByFiltersRequest
			{
				PageNumber = state.Page + 1,
				PageSize = state.PageSize,
				LogicalOperator = "AND",
				SortBy = sortBy,
				Filters = filters
			};

			var response = await ClientService.GetAllClientsAsync(request);

			return new GridData<Client>
			{
				TotalItems = response.TotalCount,
				Items = response.Items
			};
		}
		catch (Exception ex)
		{
			NotificationService.ShowError($"Ошибка загрузки данных: {ex.Message}");
			return new GridData<Client>
			{
				TotalItems = 0,
				Items = new List<Client>()
			};
		}
		finally
		{
			loading = false;
		}
	}

	private string MapPropertyToField(string propertyName)
	{
		var mapping = new Dictionary<string, string>
		{
			{ "Id", "Id" },
			{ "Name", "Name" },
			{ "LastName", "LastName" },
			{ "Patronymic", "Patronymic" },
			{ "Address", "Address" },
			{ "City", "City" },
			{ "Region", "Region" },
			{ "CompanyName", "CompanyName" },
			{ "Email", "Email" },
			{ "PhoneNumber", "PhoneNumber" },
			{ "CreatedDate", "CreatedDate" },
			{ "ModifiedDate", "ModifiedDate" },
			{ "IsDeleted", "IsDeleted" }
		};
		return mapping.TryGetValue(propertyName, out var field) ? field : propertyName;
	}

	private GetByFiltersRequest.FilterOperator MapFilterOperator(string mudOperator)
	{
		if (string.IsNullOrEmpty(mudOperator))
			return GetByFiltersRequest.FilterOperator.Contains;

		return mudOperator.ToLower() switch
		{
			"contains" or "not contains" => GetByFiltersRequest.FilterOperator.Contains,
			"equals" or "=" => GetByFiltersRequest.FilterOperator.Equals,
			"not equals" or "!=" => GetByFiltersRequest.FilterOperator.NotEquals,
			"greater than" or ">" => GetByFiltersRequest.FilterOperator.GreaterThan,
			"less than" or "<" => GetByFiltersRequest.FilterOperator.LessThan,
			"starts with" => GetByFiltersRequest.FilterOperator.StartsWith,
			"ends with" => GetByFiltersRequest.FilterOperator.EndsWith,
			_ => GetByFiltersRequest.FilterOperator.Contains
		};
	}

	private string GetValueType(object value)
	{
		if (value == null) return "string";
		return value.GetType().Name.ToLower() switch
		{
			"string" => "string",
			"int32" or "int64" => "number",
			"datetime" => "date",
			"boolean" => "boolean",
			_ => "string"
		};
	}

	private async Task OnSearch(string searchText)
	{
		searchString = searchText;

		searchDebounceTimer?.Dispose();

		searchDebounceTimer = new Timer(async _ =>
		{
			await InvokeAsync(async () =>
			{
				await dataGrid.ReloadServerData();
				StateHasChanged();
			});
		}, null, SEARCH_DEBOUNCE_MS, Timeout.Infinite);
	}

	private async Task OnShowDeletedChanged()
	{
		await dataGrid.ReloadServerData();
	}

	private async Task CreateClient()
	{
		var newClient = new CreateClient();

		var parameters = new DialogParameters
		{
			["CreateClient"] = newClient,
			["IsEdit"] = false
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<ClientEditDialog>("Создание клиента", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task EditClient(Client client)
	{
		var parameters = new DialogParameters
		{
			["Client"] = client,
			["IsEdit"] = true
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<ClientEditDialog>("Редактирование клиента", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task DeleteClient(Client client)
	{
		var deleted = await DialogServiceExtensions.ShowDeleteDialog(
			DialogService,
			client,
			"Удаление клиента",
			c => $"{c.Name} {c.LastName}",
			null,
			async (c) => await ClientService.DeleteClientAsync(c.Id)
		);

		if (deleted)
		{
			NotificationService.ShowSuccess($"Клиент {client.Name} {client.LastName} удален");
			await dataGrid.ReloadServerData();
		}
	}
}