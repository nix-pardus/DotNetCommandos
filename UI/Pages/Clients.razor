@page "/clients"
@using Microsoft.AspNetCore.Authorization
@using UI.Models
@using UI.Models.Clients
@using UI.Services
@using UI.Components
@inject IClientService ClientService
@inject INotificationService NotificationService
@inject IDialogService DialogService
@inject IUserPreferencesService UserPreferencesService
@inject NavigationManager NavigationManager

@attribute [Authorize]

<MudDataGrid @ref="dataGrid"
			 T="Client"
			 ServerData="@ServerReload"
			 Filterable
			 FilterMode="DataGridFilterMode.ColumnFilterMenu"
			 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
			 SortMode="SortMode.Multiple"
			 Hideable
			 DragDropColumnReordering
			 ColumnsPanelReordering
			 RowsPerPage="10"
			 FixedHeader
			 Hover
			 Loading="@loading"
			 ShowMenuIcon
			 ColumnResizeMode="ResizeMode.Container">

	<ToolBarContent>
		<MudText Typo="Typo.h6">Клиенты</MudText>
		<MudSpacer />

		<MudButton OnClick="CreateClient" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">
			Создать клиента
		</MudButton>

		<MudTooltip Text="Показать/скрыть удаленных клиентов">
			<MudSwitch @bind-Value="showDeleted" @bind-Value:after="OnShowDeletedChanged" Color="Color.Primary" Label="Показать удаленных" />
		</MudTooltip>
		<MudSpacer />

		<MudTextField T="string"
					  Value="@searchString"
					  ValueChanged="@OnSearch"
					  Placeholder="Быстрый поиск..."
					  Adornment="Adornment.Start"
					  AdornmentIcon="@Icons.Material.Filled.Search"
					  IconSize="Size.Medium"
					  Immediate="true"
					  Class="mt-0" />
	</ToolBarContent>

	<Columns>
		<PropertyColumn Property="x => x.FullName" Title="ФИО" Sortable="true" Filterable="true"
						@bind-Hidden="_fullNameHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.Address" Title="Адрес" Sortable="true" Filterable="true"
						@bind-Hidden="_addressHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				<MudTooltip Text="@context.Item.Address" Delay="500">
					<MudText Style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
						@context.Item.Address
					</MudText>
				</MudTooltip>
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.City" Title="Город"
						@bind-Hidden="_cityHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.Region" Title="Район"
						@bind-Hidden="_regionHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.CompanyName" Title="Компания"
						@bind-Hidden="_companyNameHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.Email" Title="Email"
						@bind-Hidden="_emailHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.PhoneNumber" Title="Телефон"
						@bind-Hidden="_phoneNumberHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.CreatedDate" Title="Дата создания"
						@bind-Hidden="_createdDateHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@context.Item.CreatedDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.ModifiedDate" Title="Дата изменения"
						@bind-Hidden="_modifiedDateHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@(context.Item.ModifiedDate.HasValue? context.Item.ModifiedDate.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm") : "-")
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Lead" Title="Откуда узнал о нас"
						@bind-Hidden="_leadHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.IsDeleted" Title="Статус" Filterable="false"
						@bind-Hidden="_isDeletedHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@if (context.Item.IsDeleted)
				{
					<MudChip Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Удален</MudChip>
				}
				else
				{
					<MudChip Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Активен</MudChip>
				}
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => false" Title="Действия" Filterable="false" Sortable="false"
						@bind-Hidden="_actionsHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@{
					async Task Edit() => await EditClient(context.Item);
					async Task Delete() => await DeleteClient(context.Item);
					void CreateOrder() => CreateOrderForClient(context.Item);
				}
				<MudTooltip Delay="500" Text="Создать заявку">
					<MudIconButton Icon="@Icons.Material.Filled.AddTask" Size="Size.Small" Color="Color.Primary" OnClick="CreateOrder"/>
				</MudTooltip>
				<MudTooltip Delay="500" Text="Редактировать">
					<MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="Edit" />
				</MudTooltip>
				<MudTooltip Delay="500" Text="Удалить">
					<MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="Delete" />
				</MudTooltip>
			</CellTemplate>
		</PropertyColumn>
	</Columns>

	<PagerContent>
		<MudDataGridPager T="Client" />
	</PagerContent>

	<LoadingContent>
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" />
	</LoadingContent>

	<NoRecordsContent>
		<MudText Typo="Typo.body1" Class="pa-4">Нет клиентов для отображения</MudText>
	</NoRecordsContent>

</MudDataGrid>

@code {
	private MudDataGrid<Client> dataGrid;
	private bool loading = false;
	private bool showDeleted = false;
	private string searchString = string.Empty;
	private Timer? searchDebounceTimer;
	private const int SEARCH_DEBOUNCE_MS = 500;

	private bool _fullNameHidden = false;
	private bool _cityHidden = false;
	private bool _addressHidden = false;
	private bool _regionHidden = false;
	private bool _phoneNumberHidden = false;
	private bool _emailHidden = false;
	private bool _companyNameHidden = false;
	private bool _createdDateHidden = false;
	private bool _modifiedDateHidden = false;
	private bool _isDeletedHidden = false;
	private bool _actionsHidden = false;
	private bool _leadHidden = false;

	protected override async Task OnInitializedAsync()
	{
		await LoadColumnStates();
	}

	private async Task LoadColumnStates()
	{
		var savedStates = await UserPreferencesService.GetPreferenceAsync<Dictionary<string, bool>>("client_column_hidden_state");
		if (savedStates == null) return;

		foreach (var (key, value) in savedStates)
		{
			switch (key)
			{
				case "FullName": _fullNameHidden = value; break;
				case "City": _cityHidden = value; break;
				case "Address": _addressHidden = value; break;
				case "Region": _regionHidden = value; break;
				case "PhoneNumber": _phoneNumberHidden = value; break;
				case "Email": _emailHidden = value; break;
				case "CompanyName": _companyNameHidden = value; break;
				case "CreatedDate": _createdDateHidden = value; break;
				case "ModifiedDate": _modifiedDateHidden = value; break;
				case "IsDeleted": _isDeletedHidden = value; break;
				case "Actions": _actionsHidden = value; break;
				case "Lead": _leadHidden = value; break;
			}
		}
	}

	private async Task SaveColumnStates()
	{
		var columnStates = new Dictionary<string, bool>
		{
			{ "FullName", _fullNameHidden },
			{"City", _cityHidden },
			{"Address", _addressHidden },
			{"Region", _regionHidden },
			{"PhoneNumber", _phoneNumberHidden },
			{"Email", _emailHidden },
			{"CompanyName", _companyNameHidden },
			{"CreatedDate", _createdDateHidden },
			{"ModifiedDate", _modifiedDateHidden },
			{"IsDeleted", _isDeletedHidden },
			{"Actions", _actionsHidden  },
			{"Lead", _leadHidden  }
		};

		await UserPreferencesService.SetPreferenceAsync("client_column_hidden_state", columnStates);
	}

	private async Task<GridData<Client>> ServerReload(GridState<Client> state)
	{
		loading = true;

		try
		{
			var sortBy = state.SortDefinitions.Select(sort => new GetByFiltersRequest.Sorting
			{
				Field = sort.SortBy,
				Direction = sort.Descending
			}).ToList();

			if (sortBy.Where(x => x.Field == "FullName").Any())
			{
				sortBy.AddRange<GetByFiltersRequest.Sorting>([
					new()
					{
						Field = "LastName",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					},
					new()
					{
						Field = "Name",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					},
					new()
					{
						Field = "Patronymic",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					}
				]);
				sortBy.RemoveAll(x => x.Field == "FullName");
			}

			var filters = new List<GetByFiltersRequest.FilterCondition>();

			if (!showDeleted)
			{
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "IsDeleted",
					Operator = GetByFiltersRequest.FilterOperator.Equals,
					Value = "false",
					ValueType = "string"
				});
			}

			if (!string.IsNullOrWhiteSpace(searchString))
			{
				// один фильтр: Name||LastName -> сервер распарсит и сделает OR между полями
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "Name||LastName||Patronymic||Address||City||Region||CompanyName||Email||PhoneNumber",
					Operator = GetByFiltersRequest.FilterOperator.Contains,
					Value = searchString,
					ValueType = "string"
				});
			}

			foreach (var filter in state.FilterDefinitions)
			{
				if (filter is IFilterDefinition<Client> columnFilter)
				{
					string operatorString = !string.IsNullOrEmpty(columnFilter.Operator)
						? columnFilter.Operator
						: "contains";

					string filterValue = columnFilter.Value?.ToString() ?? string.Empty;
					string valueType = "string";

					if (columnFilter.Value is DateTime dateTimeValue)
					{
						DateTime utcValue = dateTimeValue.Kind == DateTimeKind.Utc
							? dateTimeValue
							: dateTimeValue.ToUniversalTime();

						filterValue = utcValue.ToString("yyyy-MM-ddTHH:mm:ssZ");
						valueType = "date";
					}
					else if (columnFilter.Value != null)
					{
						valueType = columnFilter.Value.GetType().Name.ToLower() switch
						{
							"string" => "string",
							"int32" or "int64" => "number",
							"datetime" => "date",
							"boolean" => "boolean",
							"enum" => "number",
							_ => "string"
						};
					}

					var filterCondition = new GetByFiltersRequest.FilterCondition
					{
						Field = columnFilter.Column.PropertyName,
						Operator = operatorString.Trim(' ').ToLower() switch
						{
							"contains" => GetByFiltersRequest.FilterOperator.Contains,
							"equals" or "=" or "is" => GetByFiltersRequest.FilterOperator.Equals,
							"notequals" or "!=" or "is not" => GetByFiltersRequest.FilterOperator.NotEquals,
							"greaterthan" or ">" or "is after" => GetByFiltersRequest.FilterOperator.GreaterThan,
							"is on or after" => GetByFiltersRequest.FilterOperator.GreaterThanOrEqual,
							"lessthan" or "<" or "is before" => GetByFiltersRequest.FilterOperator.LessThan,
							"is on or before" => GetByFiltersRequest.FilterOperator.LessThanOrEqual,
							"startswith" => GetByFiltersRequest.FilterOperator.StartsWith,
							"endswith" => GetByFiltersRequest.FilterOperator.EndsWith,
							"is empty" => GetByFiltersRequest.FilterOperator.IsNull,
							"is not empty" => GetByFiltersRequest.FilterOperator.IsNotNull,
							_ => GetByFiltersRequest.FilterOperator.Contains
						},
						Value = filterValue,
						ValueType = valueType
					};
					filters.Add(filterCondition);
				}
			}

			var request = new GetByFiltersRequest
			{
				PageNumber = state.Page + 1,
				PageSize = state.PageSize,
				LogicalOperator = "AND",
				SortBy = sortBy,
				Filters = filters
			};

			var response = await ClientService.GetAllClientsAsync(request);

			return new GridData<Client>
			{
				TotalItems = response.TotalCount,
				Items = response.Items
			};
		}
		catch (Exception ex)
		{
			NotificationService.ShowError($"Ошибка загрузки данных: {ex.Message}");
			return new GridData<Client>
			{
				TotalItems = 0,
				Items = new List<Client>()
			};
		}
		finally
		{
			loading = false;
		}
	}

	private string MapPropertyToField(string propertyName)
	{
		var mapping = new Dictionary<string, string>
		{
			{ "FullName", "LastName||Name||Patronymic" }
		};
		return mapping.TryGetValue(propertyName, out var field) ? field : propertyName;
	}

	private async Task OnSearch(string searchText)
	{
		searchString = searchText;

		searchDebounceTimer?.Dispose();

		searchDebounceTimer = new Timer(async _ =>
		{
			await InvokeAsync(async () =>
			{
				await dataGrid.ReloadServerData();
				StateHasChanged();
			});
		}, null, SEARCH_DEBOUNCE_MS, Timeout.Infinite);
	}

	private async Task OnShowDeletedChanged()
	{
		await dataGrid.ReloadServerData();
	}

	private void CreateOrderForClient(Client client)
	{
		NavigationManager.NavigateTo($"/orders?clientId={client.Id}");
	}

	private async Task CreateClient()
	{
		var newClient = new CreateClient();

		var parameters = new DialogParameters
		{
			["CreateClient"] = newClient,
			["IsEdit"] = false
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<ClientEditDialog>("Создание клиента", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task EditClient(Client client)
	{
		var parameters = new DialogParameters
		{
			["Client"] = client,
			["IsEdit"] = true
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<ClientEditDialog>("Редактирование клиента", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task DeleteClient(Client client)
	{
		var deleted = await DialogServiceExtensions.ShowDeleteDialog(
			DialogService,
			client,
			"Удаление клиента",
			c => $"{c.Name} {c.LastName}",
			null,
			async (c) => await ClientService.DeleteClientAsync(c.Id)
		);

		if (deleted)
		{
			NotificationService.ShowSuccess($"Клиент {client.Name} {client.LastName} удален");
			await dataGrid.ReloadServerData();
		}
	}
}