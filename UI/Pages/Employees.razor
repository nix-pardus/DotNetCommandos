@page "/employees"
@using Microsoft.AspNetCore.Authorization
@using System.Linq.Expressions
@using UI.Models
@using UI.Models.Employees
@using UI.Services
@using UI.Components
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService
@inject IDialogService DialogService
@inject IUserPreferencesService UserPreferencesService

@attribute [Authorize]

<MudDataGrid @ref="dataGrid"
			 T="Employee"
			 ServerData="@ServerReload"
			 Filterable
			 FilterMode="DataGridFilterMode.ColumnFilterMenu"
			 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
			 SortMode="SortMode.Multiple"
			 Hideable
			 DragDropColumnReordering
			 ColumnsPanelReordering
			 RowsPerPage="10"
			 FixedHeader
			 Hover
			 Loading="@loading"
			 ShowMenuIcon
			 ColumnResizeMode="ResizeMode.Container">

	<ToolBarContent>
		<MudText Typo="Typo.h6">Сотрудники</MudText>
		<MudSpacer />

		<MudButton OnClick="CreateEmployee" StartIcon="@Icons.Material.Filled.Create" Color="Color.Primary">
			Создать сотрудника
		</MudButton>

		<MudTooltip Text="Показать/скрыть удаленных сотрудников">
			<MudSwitch @bind-Value="showDeleted" @bind-Value:after="OnShowDeletedChanged" Color="Color.Primary" Label="Показать удаленных" />
		</MudTooltip>
		<MudSpacer />

		<MudTextField T="string"
					  Value="@searchString"
					  ValueChanged="@OnSearch"
					  Placeholder="Быстрый поиск..."
					  Adornment="Adornment.Start"
					  AdornmentIcon="@Icons.Material.Filled.Search"
					  IconSize="Size.Medium"
					  Immediate="true"
					  Class="mt-0" />
	</ToolBarContent>

	<Columns>
		<PropertyColumn Property="x => x.FullName" Title="ФИО" Sortable="true" Filterable="true"
						@bind-Hidden="_fullNameHidden" @bind-Hidden:after="SaveColumnStates"/>
		<PropertyColumn Property="x => x.Address" Title="Адрес" Sortable="true" Filterable="true"
						@bind-Hidden="_addressHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.Email" Title="Email" Sortable="true" Filterable="true"
						@bind-Hidden="_emailHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.PhoneNumber" Title="Номер телефона" Sortable="false" Filterable="true"
						@bind-Hidden="_phoneNumberHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="@(x => x.CreatedDate)" Title="Дата создания" Sortable="true" Filterable="true"
						@bind-Hidden="_createdDateHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@context.Item.CreatedDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.ModifiedDate" Title="Дата изменения" Sortable="true" Filterable="true"
						@bind-Hidden="_modifiedDateHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@( context.Item.ModifiedDate.HasValue ? context.Item.ModifiedDate!.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm") : "-" )
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Role" Title="Роль" Sortable="true" Filterable="true"
						@bind-Hidden="_roleHidden" @bind-Hidden:after="SaveColumnStates" />
		<PropertyColumn Property="x => x.IsDeleted" Title="Статус" Sortable="true" Filterable="false"
						@bind-Hidden="_statusHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@if (context.Item.IsDeleted)
				{
					<MudChip Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Удален</MudChip>
				}
				else
				{
					<MudChip Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Активен</MudChip>
				}
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => false" Title="Действия" Filterable="false" Sortable="false"
						@bind-Hidden="_actionsHidden" @bind-Hidden:after="SaveColumnStates">
			<CellTemplate>
				@{
					async Task Edit() => await EditEmployee(context.Item);
					async Task Delete() => await DeleteEmployee(context.Item);
				}
				<MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="Edit" />
				<MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="Delete" />
			</CellTemplate>
		</PropertyColumn>
	</Columns>

	<PagerContent>
		<MudDataGridPager T="Employee" />
	</PagerContent>

	<LoadingContent>
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" />
	</LoadingContent>

	<NoRecordsContent>
		<MudText Typo="Typo.body1" Class="pa-4">Нет сотрудников для отображения</MudText>
	</NoRecordsContent>

</MudDataGrid>

@code {
	private MudDataGrid<Employee> dataGrid;
	private bool loading = false;
	private bool showDeleted = false;
	private string searchString = string.Empty;
	private Timer? searchDebounceTimer;
	private const int SEARCH_DEBOUNCE_MS = 500;

	private bool _fullNameHidden = false;
	private bool _addressHidden = false;
	private bool _emailHidden = false;
	private bool _phoneNumberHidden = false;
	private bool _createdDateHidden = false;
	private bool _modifiedDateHidden = false;
	private bool _roleHidden = false;
	private bool _statusHidden = false;
	private bool _actionsHidden = false;

	protected override async Task OnInitializedAsync()
	{
		await LoadColumnStates();
	}

	private async Task LoadColumnStates()
	{
		var savedState = await UserPreferencesService.GetPreferenceAsync<Dictionary<string, bool>>("employees_column_hidden_state");
		if (savedState == null) return;

		foreach (var (key, value) in savedState)
		{
			switch (key)
			{
				case "FullName": _fullNameHidden = value; break;
				case "Address": _addressHidden = value; break;
				case "Email": _emailHidden = value; break;
				case "PhoneNumber": _phoneNumberHidden = value; break;
				case "CreatedDate": _createdDateHidden = value; break;
				case "ModifiedDate": _modifiedDateHidden = value; break;
				case "Role": _roleHidden = value; break;
				case "Status": _statusHidden = value; break;
				case "Actions": _actionsHidden = value; break;
			}
		}
	}

	private async Task SaveColumnStates()
	{
		var columnStates = new Dictionary<string, bool>
		{
			{ "FullName", _fullNameHidden },
			{ "Address", _addressHidden },
			{ "Email", _emailHidden },
			{ "PhoneNumber", _phoneNumberHidden },
			{ "CreatedDate", _createdDateHidden },
			{ "ModifiedDate", _modifiedDateHidden },
			{ "Role", _roleHidden },
			{ "Status", _statusHidden },
			{ "Actions", _actionsHidden }
		};

		await UserPreferencesService.SetPreferenceAsync("employees_column_hidden_state", columnStates);
	}

	private async Task<GridData<Employee>> ServerReload(GridState<Employee> state)
	{
		loading = true;

		try
		{
			var sortBy = state.SortDefinitions.Select(sort => new GetByFiltersRequest.Sorting
			{
				Field = sort.SortBy,
				Direction = sort.Descending
			}).ToList();

			if(sortBy.Where(x => x.Field == "FullName").Any())
			{
				sortBy.AddRange<GetByFiltersRequest.Sorting>([
					new()
					{
						Field = "LastName",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					},
					new()
					{
						Field = "Name",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					},
					new()
					{
						Field = "Patronymic",
						Direction = sortBy.Where(x => x.Field == "FullName").First().Direction
					}
				]);
				sortBy.RemoveAll(x => x.Field == "FullName");
			}
			

			var filters = new List<GetByFiltersRequest.FilterCondition>();

			if (!showDeleted)
			{
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "IsDeleted",
					Operator = GetByFiltersRequest.FilterOperator.Equals,
					Value = "false",
					ValueType = "string"
				});
			}

			if (!string.IsNullOrWhiteSpace(searchString))
			{
				filters.Add(new GetByFiltersRequest.FilterCondition
				{
					Field = "Name||LastName||Patronymic||PhoneNumber||Email||Address",
					Operator = GetByFiltersRequest.FilterOperator.Contains,
					Value = searchString,
					ValueType = "string"
				});
			}

			foreach (var filter in state.FilterDefinitions)
			{
				if (filter is IFilterDefinition<Employee> columnFilter)
				{
					string operatorString = !string.IsNullOrEmpty(columnFilter.Operator)
						? columnFilter.Operator
						: "contains";

					var filterCondition = new GetByFiltersRequest.FilterCondition
					{
						Field = MapPropertyToField(columnFilter.Column.PropertyName),
						Operator = MapFilterOperator(operatorString),
						Value = columnFilter.Value?.ToString() ?? "",
						ValueType = GetValueType(columnFilter.Value)
					};
					filters.Add(filterCondition);
				}
			}

			var request = new GetByFiltersRequest
			{
				PageNumber = state.Page + 1,
				PageSize = state.PageSize,
				LogicalOperator = "AND",
				SortBy = sortBy,
				Filters = filters
			};

			var response = await EmployeeService.GetAllEmployeesAsync(request);

			return new GridData<Employee>
			{
				TotalItems = response.TotalCount,
				Items = response.Items
			};
		}
		catch (Exception ex)
		{
			NotificationService.ShowError($"Ошибка загрузки данных: {ex.Message}");
			return new GridData<Employee>
			{
				TotalItems = 0,
				Items = new List<Employee>()
			};
		}
		finally
		{
			loading = false;
		}
	}

	private string MapPropertyToField(string propertyName)
	{
		var mapping = new Dictionary<string, string>
		{
			{ "FullName", "LastName||Name||Patronymic" }
		};
		return mapping.TryGetValue(propertyName, out var field) ? field : propertyName;
	}

	private GetByFiltersRequest.FilterOperator MapFilterOperator(string mudOperator)
	{
		if (string.IsNullOrEmpty(mudOperator))
			return GetByFiltersRequest.FilterOperator.Contains;

		return mudOperator.Trim(' ').ToLower() switch
		{
			"contains" => GetByFiltersRequest.FilterOperator.Contains,
			"equals" or "=" => GetByFiltersRequest.FilterOperator.Equals,
			"notequals" or "!=" => GetByFiltersRequest.FilterOperator.NotEquals,
			"greaterthan" or ">" => GetByFiltersRequest.FilterOperator.GreaterThan,
			"lessthan" or "<" => GetByFiltersRequest.FilterOperator.LessThan,
			"startswith" => GetByFiltersRequest.FilterOperator.StartsWith,
			"endswith" => GetByFiltersRequest.FilterOperator.EndsWith,
			_ => GetByFiltersRequest.FilterOperator.Contains
		};
	}

	private string GetValueType(object value)
	{
		if (value == null) return "string";
		return value.GetType().Name.ToLower() switch
		{
			"string" => "string",
			"int32" or "int64" => "number",
			"datetime" => "date",
			"boolean" => "boolean",
			_ => "string"
		};
	}

	private async Task OnSearch(string searchText)
	{
		searchString = searchText;

		searchDebounceTimer?.Dispose();

		searchDebounceTimer = new Timer(async _ =>
		{
			await InvokeAsync(async () =>
			{
				await dataGrid.ReloadServerData();
				StateHasChanged();
			});
		}, null, SEARCH_DEBOUNCE_MS, Timeout.Infinite);
	}

	private async Task OnShowDeletedChanged()
	{
		await dataGrid.ReloadServerData();
	}

	private async Task CreateEmployee()
	{
		var newEmployee = new CreateEmployee();

		var parameters = new DialogParameters
		{
			["CreateEmployee"] = newEmployee,
			["IsEdit"] = false
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<EmployeeEditDialog>("Создание сотрудника", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task EditEmployee(Employee employee)
	{
		var parameters = new DialogParameters
		{
			["Employee"] = employee,
			["IsEdit"] = true
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium
		};

		await DialogService.ShowAsync<EmployeeEditDialog>("Редактирование сотрудника", parameters, options);

		await dataGrid.ReloadServerData();
	}

	private async Task DeleteEmployee(Employee employee)
	{
		var deleted = await DialogServiceExtensions.ShowDeleteDialog(
			DialogService,
			employee,
			"Удаление сотрудника",
			emp => $"{emp.Name} {emp.LastName}",
			null,
			async emp => await EmployeeService.DeleteEmployeeAsync(emp.Id));

		if (deleted)
		{
			NotificationService.ShowSuccess($"Сотрудник {employee.Name} {employee.LastName} удален");
			await dataGrid.ReloadServerData();
		}
	}
}